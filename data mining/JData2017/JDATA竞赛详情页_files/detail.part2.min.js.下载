function success(msg){$(".success p:eq(1)").text(msg),$(".success").show(),$(".success").fadeOut(2e3)}function error(msg){$(".fail p:eq(1)").text(msg),$(".fail").show(),$(".fail").fadeOut(2e3)}function getStr(str){var tmp,LocString=String(window.document.location.href);return(tmp=new RegExp("(^|)"+str+"=([^&]*)(&|$)","gi").exec(LocString))?tmp[2]:""}function _genSkillPanelHtml(skills){for(s in skillItemTpl='<dl class="skill-item"><dt class="skill1"><span>{{s1}}<i>&gt;</i></span></dt><dd class="skill2">{{s2}}</dd></dl>',skillHtml="",skillMap={},skills.forEach(function(s){skillMap[s.c1]?skillMap[s.c1].push(s.c2):skillMap[s.c1]=[s.c2]}),skillMap)if(skillMap.hasOwnProperty(s)){var skill2s=skillMap[s],skill2Html="";skill2s.forEach(function(i){skill2Html+="<span>"+i+"</span>"}),skillHtml+=Util.genHtml({s1:s,s2:skill2Html},skillItemTpl)}return skillHtml}$(function(){var jcrop_api,boundx,boundy,avatarErr,$avatar=$("#avatar"),$previewPanel=$(".preview-panel"),$preview=$(".preview-panel img"),xsize=$previewPanel.width(),ysize=$previewPanel.height();function updatePreview(c){if(50<parseInt(c.w)){var rx=xsize/c.w,ry=ysize/c.h;$preview.css("width",Math.round(rx*boundx)+"px"),$preview.css("height",Math.round(ry*boundy)+"px"),$preview.css("margin-left","-"+Math.round(rx*c.x)+"px"),$preview.css("margin-top","-"+Math.round(ry*c.y)+"px")}}$(".capECont .changePic").click(function(){$(".avatar-dlg").show()}),$("#avatar-upload").change(function(evt){var file=evt.target;if(file.files&&file.files[0]){var reader=new FileReader;new Image;reader.onload=function(evt){$avatar.attr("style",""),$avatar.attr("src",evt.target.result),$preview.attr("src",evt.target.result),jcrop_api&&jcrop_api.destroy(),$avatar.Jcrop({onChange:updatePreview,onSelect:updatePreview,aspectRatio:xsize/ysize,boxWidth:320,boxHeight:320},function(){var bounds=this.getBounds();boundx=bounds[0],boundy=bounds[1],jcrop_api=this})},reader.readAsDataURL(file.files[0])}}),$(".dlg-footer .save-avatar").click(function(){var file=document.getElementById("avatar-upload");if(file.files&&file.files[0]||""!=file.value)if(function(){var imgs=new Image;imgs.src=$avatar.attr("src");var imgObj=$("#avatar-upload")[0],ImgFileSize=0;ImgFileSize=imgObj.files&&imgObj.files[0]?Math.round(imgObj.files[0].size):Math.round(imgs.fileSize);{if(ImgFileSize<=2097152){if(isIE=-1!=navigator.userAgent.indexOf("MSIE")){if(!/\.(jpg|jpeg|JPG)$/.test(imgs.src))return!(avatarErr="图片类型必须是jpeg或jpg格式")}else if(!/\.(jpg|jpeg|JPG)$/.test("."+imgs.src.substring(11,15)))return!(avatarErr="图片类型必须是jpeg或jpg格式");return!0}return!(avatarErr="图片大小不能超过2M")}}()){var c=jcrop_api.tellSelect(),b=jcrop_api.getBounds(),imgs=new Image;imgs.src=$avatar.attr("src");var rx=imgs.width/b[0],ry=imgs.height/b[1];$("#avatar-x").val(Math.round(c.x*rx)),$("#avatar-y").val(Math.round(c.y*ry));var w=Math.round(rx*c.w),h=Math.round(ry*c.h);if(w<10||h<10)error("请先裁剪头像");else{$("#avatar-w").val(w),$("#avatar-h").val(h);var formData=new FormData(document.getElementById("avatar-form"));Util.ajax.upload("/image/upload",formData,function(data){if(console.info(JSON.stringify(data)),data){var d=data;d.url&&Util.ajax.post("/team/modifyIcon",{comp:getStr("id"),icon:d.url},function(){$(".avatar-dlg").hide(),jcrop_api.release(),$(".capECont .cpeMess .cecPic>img, .capInfo>img:first").attr("src","//img30.360buyimg.com/img/"+d.url)},function(){error("保存失败")})}})}}else error(avatarErr);else error("请先上传图片")}),$(".dlg-footer .cancel-avatar, .dlg-header .close-avatar").click(function(){$(".avatar-dlg").hide(),jcrop_api.release()})}),$(function(){var Validator=function(){function __init(self){return{err:!0,$next:$(self).next(),txt:""}}function __auto(a){var $ele,txt;return a.err&&($ele=a.$next,txt=a.txt,$ele.text(txt),$ele.show()),!a.err}return{vName:function(self){var a=__init(self);return self.value?/^[\u0391-\uFFE5A-Za-z\d_]+$/.test(self.value)?20<self.value.length?a.txt="最多20个字":a.err=!1:a.txt="不支持特殊字符":a.txt="名称不能为空",__auto(a)},vDes:function(self){var a=__init(self);return self.value?/^[\u0391-\uFFE5A-Za-z\d\[\]\{\}\(\)\-_=,\.\!\?;]+$/g.test(self.value)?50<self.value.length?a.txt="最多50个字":a.err=!1:a.txt="含有非法字符":a.err=!1,__auto(a)}}}();function renderSkillContainer($skillContainer){console.info("renderSkillContainer"),console.info($skillContainer);var $bannedSkills=$skillContainer.siblings(".team-skill").find("span"),bannedSkillCount=$bannedSkills.length,i=0,$allSkill2=$skillContainer.find(".skill2 span"),skill2Count=$allSkill2.length;if(console.info(1),console.info($allSkill2),3<=bannedSkillCount)console.info("add class"),$allSkill2.addClass("ban");else for(console.info("remove class"),$allSkill2.removeClass("ban");i<bannedSkillCount;i++)for(var skill2=$($bannedSkills[i]).data("skill").skill2,j=0;j<skill2Count;j++){var $skill2=$($allSkill2[j]);$skill2.text()==skill2&&$skill2.addClass("ban")}}$(".capInfo .infEdit").click(function(){if($(".team-editor .team-skill>span").remove(),$(".team-edit-container .cecPic img").attr("src",$(".caption .capInfo img").attr("src")),myTeam){$(".team-editor .teamIntro").val(myTeam.des),$(".team-editor .slogan").val(myTeam.name),$(".team-editor .cecr").removeClass("recSelect"),$('.team-editor .cecr[data-type="'+myTeam.status+'"]').addClass("recSelect");var skills=JSON.parse(myTeam.needSkill||"[]");skills&&skills.forEach(function(sk){$(".team-editor .cecSkill .team-skill b").before("<span data-skill='"+JSON.stringify(sk)+"'>"+sk.skill2+"<sup>x</sup></span>")});var roles=JSON.parse(myTeam.needMember||"[]");roles&&roles.forEach(function(r){$(".team-editor .cecMember .team-skill b").before("<span data-skill='"+JSON.stringify(r)+"'>"+r.skill2+"<sup>x</sup></span>")})}renderSkillContainer($(".cecSkill .skill-container")),renderSkillContainer($(".cecMember .skill-container")),$(".capECont").show()}),$(".team-editor .cecRec .cecr").click(function(){$(".team-editor .cecRec .cecr").removeClass("recSelect"),$(this).addClass("recSelect")}),$(".capECont").click(function(){$(".skill-container").slideUp("fast")}),$(".team-editor .cecSkill .team-skill").click(function(evt){evt.stopPropagation(),$(".team-editor .cecMember .skill-container").hide(),$(this).next().next().slideToggle("fast")}),$(".team-editor .cecMember .team-skill").click(function(evt){evt.stopPropagation(),$(".team-editor .cecSkill .skill-container").hide(),$(this).next().next().slideToggle("fast")}),$(".team-editor .team-skill").delegate("sup","click",function(evt){evt.stopPropagation();var $parent=$(this).parent(),$container=$(this).parents(".team-skill").siblings(".skill-container");$parent.remove(),renderSkillContainer($container)}),$(".team-editor").delegate(".skill2 span","click",function(){if(console.info(".team-editor .skill2 span click"),console.info($(this)),!$(this).hasClass("ban")){var $skillContainer=$(this).parents(".skill-container"),$skill=$skillContainer.siblings(".team-skill");if(!(3<=$skill.find("span").length)){var sk={skill2:$(this).text(),skill:$(this).parent().prev().find("span").text()};">"==sk.skill[sk.skill.length-1]&&(sk.skill=sk.skill.substr(0,sk.skill.length-1)),$skill.find("b").before("<span data-skill='"+JSON.stringify(sk)+"'>"+sk.skill2+"<sup>x</sup></span>"),console.info("selected"),console.info($skillContainer),renderSkillContainer($skillContainer)}}}),$(".team-editor .slogan, .team-editor .teamIntro").focus(function(){$(this).next().hide()}),$(".capECont .cbCancel, .capECont .tvTit i").click(function(){$(".team-editor .slogan").val(""),$(".team-editor .teamIntro").val(""),$(".team-editor .team-skill>span").remove(),$(".capECont").hide()}),$(".capECont .cbSave").click(function(){(function(){for(var err=!0,i=0,eles=[$(".team-editor .slogan"),$(".team-editor .teamIntro")],funs=[Validator.vName,Validator.vDes];i<eles.length;i++)eles[i][0]&&(err=funs[i](eles[i][0])&&err);return err})()&&Util.ajax.postNotLoading("/team/validName",{comp:getStr("id"),name:$(".team-editor .slogan").val(),id:myTeam.id},function(data){if(data&&200==data.code&&1==data.data){for(var team={name:$(".team-editor .slogan").val(),desc:$(".team-editor .teamIntro").val(),status:$(".team-editor .cecr.recSelect").data("type"),compId:getStr("id"),id:myTeam.id},i=0,skills=[],roles=[],$skill=$(".team-editor .cecSkill .team-skill span"),$role=$(".team-editor .cecMember .team-skill span");i<$skill.length;i++)skills.push($($skill[i]).data("skill"));for(i=0;i<$role.length;i++)roles.push($($role[i]).data("skill"));team.needSkill=JSON.stringify(skills),team.needMember=JSON.stringify(roles),Util.ajax.ePost("/team/modify",team,{},function(data){if(data&&200==data.code){myTeam.name=team.name,myTeam.des=team.desc,myTeam.status=team.status,myTeam.needSkill=team.needSkill,myTeam.needMember=team.needMember;var _html=$(".capInfo .nPer").html();_html=team.name+_html.substring(_html.indexOf("<span")),$(".capInfo .nPer").html(_html);var _skill="";skills&&skills.length&&skills.forEach(function(_s){_skill+=","+_s.skill2}),$(".capInfo .infSkill>span").text(_skill.substr(1));var _role="";roles&&roles.length&&roles.forEach(function(_r){_role+=","+_r.skill2}),$(".capInfo .infMem>span").text(_role.substr(1)),$(".capInfo .infInt>span").text(team.desc);var _status="";switch(team.status){case 0:_status="开放招募";break;case 1:_status="队伍解散";break;case 2:_status="停止招募";break;case 4:_status="已满员";break;default:_status="未知"}$(".capInfo .infSta>span").text(_status),$(".capECont").hide()}else error(data.message)},function(){error("网络开小差了，请稍后重试~")})}else $(".team-editor .slogan").next().text("该名称已被占用"),$(".team-editor .slogan").next().show()})})}),Util.ajax.post("/prop/skills",{},function(data){var d=data.data;try{var skills=[];d.forEach(function(i){skills.push({c1:i.skill,c2:i.skill2})}),$(".cecSkill .skill-container").html(_genSkillPanelHtml(skills))}catch(e){console.error(e)}}),Util.ajax.post("/prop/roles",{},function(data){var d=data.data;try{var skills=[];d.forEach(function(i){skills.push({c1:i.skill,c2:i.skill2})}),$(".cecMember .skill-container").html(_genSkillPanelHtml(skills))}catch(e){console.error(e)}});